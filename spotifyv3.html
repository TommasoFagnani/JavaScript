<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canzoni Ascoltate di Recente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body>
    <div id="recenti">
        <table class="table table-dark table-striped" border="1" id="songTableRow">
            <tr>
                <th>Artista</th>
                <th>Titolo</th>
                <th>Copertina</th>
                <th>Ascolta</th>
            </tr>
        </table>
    </div>

    <div id="spotifyPlayer"></div>

    <script type="text/javascript">
        var access_token = "AQDWSlVzcIVjFPbne9YpdZOt5DQ-0HDOGL-Pt7InRKVhwFWGS1hIdysRsHhr2M3o8ThFd8n8opk-CAbpgnIxn0Wki4ByMHGSDoOQa2i995sZ0rzUxw7Ji5he1iFWur02Fat_zPG-AKyj3e00EAxA2KOWnyK3p0Qxk7cw6fRM2fe49AmGSmbgtoiInA31JgV9zHzFF8x9szGs24YG-GGjPbPOS7ESuqbCzdaROuxA2QaK0t-Mf6fzutqMGo7EUMuQwA";

        async function ascoltiRecenti() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/recently-played', {
                    headers: {
                        'Authorization': `Bearer ${access_token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Errore nella richiesta: ${response.status}`);
                }

                const jsonData = await response.json();
                return jsonData.items;
            } catch (error) {
                console.error('Errore durante la richiesta:', error);
                return [];
            }
        }

        async function renderTable() {
            try {
                const recentSongs = await ascoltiRecenti();
                let tbody = "";

                recentSongs.forEach((song, index) => {
                    const artistName = song.track.artists[0].name;
                    const songTitle = song.track.name;
                    const albumCoverUrl = song.track.album.images[0].url;
                    const songId = song.track.id;
                    const albumID = song.track.album.id;

                    tbody += "<tr>";
                    tbody += `<td>${artistName}</td>`;
                    tbody += `<td>${songTitle}</td>`;
                    tbody += `<td><img src="${albumCoverUrl}" onclick="listaCanzoni('${albumID}')" alt="Copertina Album" width="50"></td>`;
                    tbody += `<td><button class="btn btn-dark" onclick="playSong('${songId}', '${songTitle}', '${albumCoverUrl}', ${index})">Play</button></td>`;
                    tbody += "</tr>";
                });

                const tableRow = document.getElementById('songTableRow');
                tableRow.innerHTML += tbody;
            } catch (error) {
                console.error('Errore durante la visualizzazione dei dati:', error);
            }
        }

        async function fetchAlbumData(albumID) {
            try {
                const response = await fetch(`https://api.spotify.com/v1/albums/${albumID}`, {
                    headers: {
                        'Authorization': `Bearer ${access_token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Errore nella richiesta: ${response.status}`);
                }

                const userData = await response.json();
                return userData;
            } catch (error) {
                console.error('Errore durante la richiesta:', error);
                return null;
            }
        }

        function mostra() {
            const tabellaRecenti = document.getElementById('recenti');
            tabellaRecenti.style.display = "";
        }

        async function listaCanzoni(albumID) {
            const jsonAlbumData = await fetchAlbumData(albumID);
            const tracks = jsonAlbumData.tracks.items;
            const lista = document.getElementById('albumRec');
            lista.innerHTML = ''; // Pulisci il contenuto precedente

            let selectHtml = '<select onchange="playSelectedSong(this)">';
            selectHtml += '<option value="">Seleziona una canzone</option>';

            tracks.forEach(track => {
                selectHtml += `<option value="${track.id}">${track.name}</option>`;
            });
            selectHtml += '</select>';

            const selectCell = document.createElement('td');
            selectCell.innerHTML = selectHtml;

            lista.appendChild(selectCell);
        }

        async function playSong(songId, songTitle, albumCoverUrl, selectedIndex) {
            const tableRows = document.getElementById('songTableRow').rows;

            // Rimuovi eventuali player gi√† presenti
            for (let i = 0; i < tableRows.length; i++) {
                if (i !== selectedIndex) {
                    const playerRow = document.getElementById(`playerRow-${i}`);
                    if (playerRow) {
                        playerRow.remove();
                    }
                }
            }

            const selectedRow = tableRows[selectedIndex];
            if (selectedRow) {
                const playerHtml = `
                    <tr id="playerRow-${selectedIndex}">
                        <td colspan="4">
                            <div>
                                <p>Stai ascoltando: ${songTitle}</p>
                                <iframe src="https://open.spotify.com/embed/track/${songId}"
                                        width="300" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media">
                                </iframe>
                            </div>
                        </td>
                    </tr>
                `;

                selectedRow.innerHTML('afterend', playerHtml);
            }
        }

        renderTable();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>
</html>
